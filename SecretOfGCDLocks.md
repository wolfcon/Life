<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**

- [GCD çš„ãŠ™ï¸ä¹‹ - ğŸ”](#gcd-%E7%9A%84%E4%B9%8B---)
      - [çº¿ç¨‹å®‰å…¨](#%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8)
      - [Objective-Cä¸­çš„åŒæ­¥é”](#objective-c%E4%B8%AD%E7%9A%84%E5%90%8C%E6%AD%A5%E9%94%81)
        - [åŒæ­¥å—(synchronization block)](#%E5%90%8C%E6%AD%A5%E5%9D%97synchronization-block)
      - [é”å¯¹è±¡](#%E9%94%81%E5%AF%B9%E8%B1%A1)
      - [GCDé”](#gcd%E9%94%81)
          - [ä»»åŠ¡æ´¾å‘](#%E4%BB%BB%E5%8A%A1%E6%B4%BE%E5%8F%91)
          - [é˜Ÿåˆ—ç§ç±»](#%E9%98%9F%E5%88%97%E7%A7%8D%E7%B1%BB)
          - [GCDé˜Ÿåˆ—ç§ç±»](#gcd%E9%98%9F%E5%88%97%E7%A7%8D%E7%B1%BB)
          - [ä»¥å‰åŒæ­¥é”çš„å®ç°æ–¹å¼](#%E4%BB%A5%E5%89%8D%E5%90%8C%E6%AD%A5%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F)
          - [ä½¿ç”¨GCDä¸²è¡Œé˜Ÿåˆ—æ¥å®ç°åŒæ­¥é”](#%E4%BD%BF%E7%94%A8gcd%E4%B8%B2%E8%A1%8C%E9%98%9F%E5%88%97%E6%9D%A5%E5%AE%9E%E7%8E%B0%E5%90%8C%E6%AD%A5%E9%94%81)
          - [ä½¿ç”¨GCDå¹¶å‘é˜Ÿåˆ—æ¥å®ç°åŒæ­¥é”](#%E4%BD%BF%E7%94%A8gcd%E5%B9%B6%E5%8F%91%E9%98%9F%E5%88%97%E6%9D%A5%E5%AE%9E%E7%8E%B0%E5%90%8C%E6%AD%A5%E9%94%81)
          - [GCDå¹¶å‘é˜Ÿåˆ—ä¸­åŠ å…¥æ …æ ](#gcd%E5%B9%B6%E5%8F%91%E9%98%9F%E5%88%97%E4%B8%AD%E5%8A%A0%E5%85%A5%E6%A0%85%E6%A0%8F)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->



# GCD çš„ãŠ™ï¸ä¹‹ - ğŸ”

> æœ¬æ–‡æ•´ç†è‡ªã€ŠEffective Objective-C 2.0ã€‹ï¼Œé€šè¿‡åˆ†ææ¯”è¾ƒä¸åŒçš„åŒæ­¥é”çš„ä¼˜ç¼ºç‚¹ï¼Œä½¿ç”¨GCDæ–¹æ³•ä¸€æ­¥æ­¥æ‰¾åˆ°æ›´é«˜æ•ˆçš„åŒæ­¥é”ã€‚

åœ¨Objective-Cä¸­ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹è¦æ‰§è¡ŒåŒä¸€ä»½ä»£ç ï¼Œé‚£ä¹ˆè¿™æ—¶å°±ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸‹ä»€ä¹ˆæ—¶å€™çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

#### çº¿ç¨‹å®‰å…¨

å¦‚æœä¸€æ®µä»£ç æ‰€åœ¨çš„è¿›ç¨‹ä¸­æœ‰å¤šä¸ªçº¿ç¨‹åœ¨åŒæ—¶è¿è¡Œï¼Œé‚£ä¹ˆè¿™äº›çº¿ç¨‹å°±æœ‰å¯èƒ½ä¼šåŒæ—¶è¿è¡Œè¿™æ®µä»£ç ã€‚å‡å¦‚å¤šä¸ªçº¿ç¨‹æ¯æ¬¡è¿è¡Œç»“æœå’Œå•çº¿ç¨‹è¿è¡Œçš„ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œè€Œä¸”å…¶ä»–çš„å˜é‡çš„å€¼ä¹Ÿå’Œé¢„æœŸçš„æ˜¯ä¸€æ ·çš„ï¼Œå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

ç”±äºå¯è¯»å†™çš„å…¨å±€å˜é‡åŠé™æ€å˜é‡ï¼ˆåœ¨ Objective-C ä¸­è¿˜åŒ…æ‹¬å±æ€§å’Œå®ä¾‹å˜é‡ï¼‰å¯ä»¥åœ¨ä¸åŒçº¿ç¨‹ä¿®æ”¹ï¼Œæ‰€ä»¥è¿™ä¸¤è€…ä¹Ÿé€šå¸¸æ˜¯å¼•èµ·çº¿ç¨‹å®‰å…¨é—®é¢˜çš„æ‰€åœ¨ã€‚

#### Objective-Cä¸­çš„åŒæ­¥é”

åœ¨ Objective-C ä¸­ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹æ‰§è¡ŒåŒä¸€ä»½ä»£ç ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå°±éœ€è¦ä½¿ç”¨æ‰€æ¥å®ç°æŸç§åŒæ­¥æœºåˆ¶ã€‚

åœ¨ GCDå‡ºç°ä¹‹å‰ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§é‡‡ç”¨çš„æ˜¯å†…ç½®çš„â€œåŒæ­¥å—â€(synchronization block)ï¼Œå¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨é”å¯¹è±¡ã€‚

##### åŒæ­¥å—(synchronization block)

```objc
- (void)synchronizedMethod {
    @synchronized (self) {
        //Safe
    }
}
```

è¿™ç§å†™æ³•ä¼šæ ¹æ®ç»™å®šçš„å¯¹è±¡ï¼Œè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªé”ï¼Œå¹¶ç­‰å¾…å—ä¸­çš„ä»£ç æ‰§è¡Œå®Œæ¯•ã€‚æ‰§è¡Œåˆ°è¿™æ®µä»£ç ç»“å°¾å¤„ï¼Œé”å°±é‡Šæ”¾äº†ã€‚

è¯¥åŒæ­¥æ–¹æ³•çš„ä¼˜ç‚¹å°±æ˜¯æˆ‘ä»¬ä¸éœ€è¦åœ¨ä»£ç ä¸­æ˜¾å¼çš„åˆ›å»ºé”å¯¹è±¡ï¼Œä¾¿å¯ä»¥å®ç°é”çš„æœºåˆ¶ã€‚ç„¶è€Œï¼Œæ»¥ç”¨@synchronized (self)åˆ™ä¼šé™ä½ä»£ç æ•ˆç‡ï¼Œå› ä¸ºå…¬ç”¨åŒä¸€ä¸ªé”çš„é‚£äº›åŒæ­¥å—ï¼Œéƒ½å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œã€‚è‹¥æ˜¯åœ¨selfå¯¹è±¡ä¸Šé¢‘ç¹åŠ é”ï¼Œç¨‹åºå¯èƒ½è¦ç­‰å¦ä¸€æ®µä¸æ­¤æ— å…³çš„ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œå½“å‰ä»£ç ï¼Œè¿™æ ·æ•ˆç‡å°±ä½äº†ã€‚
*æ³¨ï¼šå› ä¸º@synchronized (self)æ–¹æ³•é’ˆå¯¹selfåªæœ‰ä¸€ä¸ªé”ï¼Œç›¸å½“äºå¯¹äºselfçš„æ‰€æœ‰ç”¨åˆ°åŒæ­¥å—çš„åœ°æ–¹éƒ½æ˜¯å…¬ç”¨åŒä¸€ä¸ªé”ï¼Œæ‰€ä»¥å¦‚æœæœ‰å¤šä¸ªåŒæ­¥å—ï¼Œåˆ™å…¶ä»–çš„åŒæ­¥å—éƒ½è¦ç­‰å¾…å½“å‰åŒæ­¥å—æ‰§è¡Œå®Œæ¯•æ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚*

```objc
- (void)synchronizedAMethod {
    @synchronized (self) {
        //Safe
    }
}

- (void)synchronizedBMethod {
    @synchronized (self) {
        //Safe
    }
}

- (void)synchronizedCMethod {
    @synchronized (self) {
        //Safe
    }
}
```

ä»¥ä¸Šä»£ç ï¼Œå¦‚æœå½“å‰`synchronizedAMethod`æ–¹æ³•æ­£åœ¨æ‰§è¡Œï¼Œåˆ™`synchronizedBMethod`å’Œ`synchronizedCMethod`æ–¹æ³•éœ€è¦ç­‰å¾…`synchronizedAMethod`å®Œæ¯•åæ‰èƒ½æ‰§è¡Œï¼Œä¸èƒ½è¾¾åˆ°å¹¶å‘çš„æ•ˆæœã€‚

#### é”å¯¹è±¡

```objc
@property (nonatomic,strong) NSLock *lock;

_lock = [[NSLock alloc] init];

- (void)synchronizedMethod {
    [_lock lock];
    //Safe
    [_lock unlock];
}
```

ä»¥ä¸Šæ˜¯ç®€å•é”å¯¹è±¡çš„å®ç°æ–¹å¼ï¼Œä½†æ˜¯å¦‚æœé”ä½¿ç”¨ä¸å½“ï¼Œä¼šå‡ºç°æ­»é”ç°è±¡ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨NSRecursiveLockè¿™ç§â€œé€’å½’é”â€ï¼ˆrecursive lockï¼‰ã€‚

é™¤äº†ä»¥ä¸Šé”å¯¹è±¡ï¼Œè¿˜æœ‰NSConditionLock æ¡ä»¶é” ã€NSDistributedLock åˆ†å¸ƒå¼é” ï¼Œè¿™äº›é€‚ç”¨äºä¸åŒçš„åœºæ™¯ï¼Œè¿™é‡Œå°±ä¸å±•å¼€è¯´äº†ã€‚

ä»¥ä¸Šè¿™äº›é”ï¼Œä½¿ç”¨çš„æ—¶å€™è¿˜æ˜¯æœ‰ç¼ºé™·çš„ã€‚åœ¨æç«¯æƒ…å†µä¸‹ï¼ŒåŒæ­¥å—ä¼šå¯¼è‡´æ­»é”ï¼Œå¦å¤–ï¼Œæ•ˆç‡ä¹Ÿä¸è§å¾—é«˜ï¼Œè€Œå¦‚æœç›´æ¥ä½¿ç”¨é”å¯¹è±¡çš„è¯ï¼Œä¸€æ—¦é‡åˆ°æ­»é”ï¼Œå°±ä¼šéå¸¸éº»çƒ¦ã€‚

#### GCDé”

åœ¨å¼€å§‹è¯´GCDé”ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹GCDçš„ä¸­çš„ä»»åŠ¡æ´¾å‘å’Œé˜Ÿåˆ—ã€‚

###### ä»»åŠ¡æ´¾å‘

| ä»»åŠ¡æ´¾å‘æ–¹å¼     | è¯´æ˜                                                         |
| ---------------- | ------------------------------------------------------------ |
| dispatch_sync()  | åŒæ­¥æ‰§è¡Œï¼Œå®Œæˆäº†å®ƒé¢„å®šçš„ä»»åŠ¡åæ‰è¿”å›ï¼Œé˜»å¡å½“å‰çº¿ç¨‹           |
| dispatch_async() | å¼‚æ­¥æ‰§è¡Œï¼Œä¼šç«‹å³è¿”å›ï¼Œé¢„å®šçš„ä»»åŠ¡ä¼šå®Œæˆä½†ä¸ä¼šç­‰å®ƒå®Œæˆï¼Œä¸é˜»å¡å½“å‰çº¿ç¨‹ |

###### é˜Ÿåˆ—ç§ç±»

| é˜Ÿåˆ—ç§ç±» | è¯´æ˜                                                 |
| -------- | ---------------------------------------------------- |
| ä¸²è¡Œé˜Ÿåˆ— | æ¯æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶ä¸”å¿…é¡»ç­‰å¾…å‰ä¸€ä¸ªæ‰§è¡Œä»»åŠ¡å®Œæˆ |
| å¹¶å‘é˜Ÿåˆ— | ä¸€æ¬¡å¯ä»¥å¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œä¸å¿…ç­‰å¾…æ‰§è¡Œä¸­çš„ä»»åŠ¡å®Œæˆ   |

###### GCDé˜Ÿåˆ—ç§ç±»

| GCDé˜Ÿåˆ—ç§ç±» | è·å–æ–¹æ³•                  | é˜Ÿåˆ—ç±»å‹   | è¯´æ˜         |
| ----------- | ------------------------- | ---------- | ------------ |
| ä¸»é˜Ÿåˆ—      | dispatch_get_main_queue   | ä¸²è¡Œé˜Ÿåˆ—   | ä¸»çº¿ä¸­æ‰§è¡Œ   |
| å…¨å±€é˜Ÿåˆ—    | dispatch_get_global_queue | å¹¶å‘é˜Ÿåˆ—   | å­çº¿ç¨‹ä¸­æ‰§è¡Œ |
| ç”¨æˆ·é˜Ÿåˆ—    | dispatch_queue_create     | ä¸²å¹¶éƒ½å¯ä»¥ | å­çº¿ç¨‹ä¸­æ‰§è¡Œ |

###### ä»¥å‰åŒæ­¥é”çš„å®ç°æ–¹å¼

åœ¨Objective-Cä¸­ï¼Œå±æ€§å°±æ˜¯å¼€å‘è€…ç»å¸¸éœ€è¦åŒæ­¥çš„åœ°æ–¹ã€‚é€šå¸¸å¼€å‘è€…æƒ³çœäº‹çš„è¯ï¼ˆä»¥å‰æˆ‘ä¹Ÿæ˜¯è¿™æ ·è§‰å¾—ï¼‰ï¼Œä¼šè¿™æ ·å†™ï¼š

```objective-c
- (NSString *)someString {
    @synchronized (self) {
        return _someString;
    }
}

- (void)setSomeString:(NSString *)someString {
    @synchronized (self) {
        _someString = someString;
    }
}
```

ä»¥ä¸Šä»£ç é™¤äº†ä¸Šæ–‡æåˆ°çš„æ•ˆç‡ä½ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¯¥æ–¹æ³•å¹¶ä¸èƒ½ä¿è¯è®¿é—®è¯¥å¯¹è±¡æ—¶ç»å¯¹æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚è™½ç„¶ï¼Œè¿™ç§æ–¹æ³•åœ¨è®¿é—®å±æ€§æ—¶ï¼Œç¡®å®æ˜¯â€œåŸå­â€çš„ï¼Œä¹Ÿå¿…å®šèƒ½ä»ä¸­è·å–åˆ°æœ‰æ•ˆå€¼ï¼Œç„¶è€Œåœ¨åŒä¸€çº¿ç¨‹ä¸Šå¤šæ¬¡è°ƒç”¨getteræ–¹æ³•ï¼Œæ¯æ¬¡è·å–åˆ°çš„ç»“æœæœªå¿…ç›¸åŒã€‚åœ¨ä¸¤æ¬¡è®¿é—®æ“ä½œä¹‹é—´ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½ä¼šå†™å…¥æ–°çš„å±æ€§å€¼ã€‚æ­¤æ—¶ï¼Œåªèƒ½ä¿è¯è¯»å†™æ“ä½œæ˜¯â€œåŸå­â€çš„ï¼Œè€Œå¤šä¸ªçº¿ç¨‹çš„æ‰§è¡Œé¡ºåºï¼Œæˆ‘ä»¬æ²¡æœ‰åŠæ³•æ§åˆ¶ã€‚

###### ä½¿ç”¨GCDä¸²è¡Œé˜Ÿåˆ—æ¥å®ç°åŒæ­¥é”

æœ‰ç§ç®€å•è€Œé«˜æ•ˆçš„æ–¹æ³•å¯ä»¥æ›¿ä»£åŒæ­¥å—æˆ–é”å¯¹è±¡ï¼Œé‚£å°±æ˜¯ä½¿ç”¨â€œä¸²è¡ŒåŒæ­¥é˜Ÿåˆ—â€ã€‚å°†è¯»å–æ“ä½œä»¥åŠå†™å…¥æ“ä½œéƒ½å®‰æ’åœ¨åŒä¸€ä¸ªé˜Ÿåˆ—é‡Œï¼Œå³å¯ä¿è¯æ•°æ®åŒæ­¥ã€‚
ç”¨æ³•å¦‚ä¸‹ï¼š

```objc
@property (nonatomic,strong) dispatch_queue_t syncQueue;

_syncQueue = dispatch_queue_create("com.effetiveobjectivec.syncQueue", NULL);

- (NSString *)someString {
    __block NSString *localSomeString;
    dispatch_sync(_syncQueue, ^{
        localSomeString = _someString;
    });
    return _someString;
}

- (void)setSomeString:(NSString *)someString {
    dispatch_sync(_syncQueue, ^{
        _someString = someString;
    });
}
```

æ­¤æ¨¡å¼çš„æ€è·¯æ˜¯ï¼šæŠŠè®¾ç½®æ“ä½œä¸è·å–æ“ä½œéƒ½å®‰æ’åœ¨åºåˆ—åŒ–çš„é˜Ÿåˆ—é‡Œæ‰§è¡Œï¼Œè¿™æ ·çš„è¯ï¼Œæ‰€æœ‰é’ˆå¯¹å±æ€§çš„è®¿é—®æ“ä½œå°±éƒ½åŒæ­¥äº†ã€‚
*æ³¨ï¼šgetteræ–¹æ³•ä¸­ï¼Œç”¨ä¸€ä¸ªä¸´æ—¶å˜é‡æ¥ä¿å­˜å€¼ï¼Œæ˜¯å› ä¸ºåœ¨blockä¸­returnçš„è¯ï¼Œåªæ˜¯returnåˆ°blockä¸­äº†ï¼Œæ²¡æœ‰çœŸæ­£è¿”å›åˆ°å¯¹åº”çš„getteræ–¹æ³•ä¸­ï¼Œè€Œ__blockæ˜¯ä¸ºäº†å¯ä»¥åœ¨blockä¸­æ”¹å˜æ”¹ä¸´æ—¶å˜é‡è€Œç”¨ã€‚*

è™½ç„¶é—®é¢˜è§£å†³äº†ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚è®¾ç½®æ–¹æ³•ä¸ä¸€å®šéå¾—æ˜¯åŒæ­¥çš„ã€‚è®¾ç½®å®ä¾‹å˜é‡æ‰€ç”¨çš„å—ï¼Œå¹¶ä¸éœ€è¦å‘è®¾ç½®æ–¹æ³•è¿”å›ä»€ä¹ˆå€¼ã€‚é‚£ä»£ç å¯ä»¥æ”¹æˆï¼š

```objc
- (void)setSomeString:(NSString *)someString {
    dispatch_async(_syncQueue, ^{
        _someString = someString;
    });
}
```

è¿™æ¬¡æŠŠåŒæ­¥æ”¹æˆäº†å¼‚æ­¥ï¼Œä¹Ÿè®¸çœ‹æ¥ï¼Œè¿™æ ·æ”¹åŠ¨ï¼Œæ€§èƒ½æ˜¯ä¼šæœ‰æå‡çš„ï¼Œä½†æ˜¯ä½ æµ‹ä¸€ä¸‹ç¨‹åºçš„æ€§èƒ½ï¼Œå¯èƒ½ä¼šå‘ç°è¿™ç§å†™æ³•æ¯”åŸæ¥æ…¢ã€‚å› ä¸ºæ‰§è¡Œå¼‚æ­¥æ´¾å‘æ—¶ï¼Œæ˜¯éœ€è¦æ‹·è´å—ã€‚è‹¥æ‹·è´å—æ‰€ç”¨çš„æ—¶é—´æ˜æ˜¾è¶…è¿‡æ‰§è¡Œå—æ‰€éœ€çš„æ—¶é—´ï¼Œåˆ™è¿™ç§åšæ³•å°†æ¯”åŸæ¥çš„æ›´æ…¢ã€‚
*æ³¨ï¼šæœ¬ä¾‹å­ä»£ç æ¯”è¾ƒç®€å•ï¼Œè‹¥æ˜¯è¦æ‰§è¡Œçš„å—ä»£ç é€»è¾‘æ¯”è¾ƒå¤æ‚çš„è¯ï¼Œé‚£ä¹ˆè¯¥å†™æ³•å¯èƒ½è¿˜æ˜¯æ¯”åŸæ¥çš„å—äº›*

###### ä½¿ç”¨GCDå¹¶å‘é˜Ÿåˆ—æ¥å®ç°åŒæ­¥é”

å¯¹äºå±æ€§çš„è¯»å†™ï¼Œæˆ‘ä»¬å¸Œæœ›å¤šä¸ªè·å–æ–¹æ³•å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œè€Œè·å–æ–¹æ³•ä¸è®¾ç½®æ–¹æ³•ä¹‹é—´ä¸èƒ½å¹¶å‘æ‰§è¡Œï¼Œåˆ©ç”¨è¿™ä¸ªç‰¹ç‚¹ï¼Œè¿˜èƒ½å†™å‡ºæ›´å¿«ä¸€äº›çš„ä»£ç æ¥ã€‚æ­¤æ—¶æ­£å¯ä½“ç°å‡ºGCDçš„å¥½å¤„ã€‚è€Œç”¨åŒæ­¥é”æˆ–é”å¯¹è±¡ï¼Œæ˜¯æ— æ³•è½»æ˜“å®ç°ä¸‹é¢è¿™ç§æ–¹æ¡ˆçš„ã€‚è¿™æ¬¡æˆ‘ä»¬ä½¿ç”¨å¹¶å‘é˜Ÿåˆ—ï¼š

```objc
@property (nonatomic,strong) dispatch_queue_t syncQueue;

_syncQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);

- (NSString *)someString {
    __block NSString *localSomeString;
    dispatch_sync(_syncQueue, ^{
        localSomeString = _someString;
    });
    return localSomeString;
}

- (void)setSomeString:(NSString *)someString {
    dispatch_async(_syncQueue, ^{
        _someString = someString;
    });
}
```

ä»¥ä¸Šä»£ç ï¼Œè¿˜æ— æ³•æ­£ç¡®å®ç°åŒæ­¥ã€‚å› ä¸ºæ‰€æœ‰è¯»å†™æ“ä½œéƒ½ä¼šåœ¨åŒä¸€ä¸ªé˜Ÿåˆ—ä¸Šæ‰§è¡Œï¼Œè€Œè¯¥é˜Ÿåˆ—æ˜¯å¹¶å‘é˜Ÿåˆ—ï¼Œæ‰€æœ‰è¯»å–å’Œå†™å…¥æ“ä½œéƒ½å¯ä»¥éšæ—¶æ‰§è¡Œï¼Œæ²¡æœ‰è¾¾åˆ°åŒæ­¥æ•ˆæœã€‚æ­¤é—®é¢˜æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å•çš„GCDåŠŸèƒ½è§£å†³--æ …æ ï¼ˆbarrierï¼‰ã€‚ä¸‹åˆ—å‡½æ•°å¯ä»¥å‘é˜Ÿåˆ—ä¸­æ´¾å‘å—ï¼Œå°†å…¶ä½œä¸ºæ …æ ä½¿ç”¨ï¼š

```
void dispatch_barrier_async(dispatch_queue_t queue, dispatch_block_t block);
void dispatch_barrier_sync(dispatch_queue_t queue, dispatch_block_t block);
```

*æ³¨ï¼šdispatch_barrier_asyncå¦‚æœä¼ å…¥è‡ªå·±åˆ›å»ºçš„å¹¶è¡Œé˜Ÿåˆ—æ—¶ï¼Œä¼šé˜»å¡å½“å‰é˜Ÿåˆ—æ‰§è¡Œï¼Œè€Œä¸é˜»å¡å½“å‰çº¿ç¨‹ã€‚dispatch_barrier_syncå¦‚æœä¼ å…¥è‡ªå·±åˆ›å»ºçš„å¹¶è¡Œé˜Ÿåˆ—æ—¶ï¼Œé˜»å¡å½“å‰é˜Ÿåˆ—çš„åŒæ—¶ä¹Ÿä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œè¯·æ³¨æ„*

å¹¶å‘é˜Ÿåˆ—å¦‚æœå‘ç°æ¥ä¸‹æ¥è¦å¤„ç†çš„å—æ˜¯ä¸ªæ …æ å—ï¼Œé‚£ä¹ˆå°±ä¸€ç›´è¦ç­‰å½“å‰æ‰€æœ‰å¹¶å‘å—éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œæ‰ä¼šå•ç‹¬æ‰§è¡Œè¿™ä¸ªæ …æ å—ã€‚è¿™å¾…æ …æ å—æ‰§è¡Œå®Œæ¯•ï¼Œåœ¨æŒ‰æ­£å¸¸æ–¹å¼ç»§ç»­å‘ä¸‹å¤„ç†ã€‚è¿™æ ·å°±è§£å†³äº†å¹¶å‘é˜Ÿåˆ—çš„åŒæ­¥é—®é¢˜ã€‚

###### GCDå¹¶å‘é˜Ÿåˆ—ä¸­åŠ å…¥æ …æ 

æœ¬ä¾‹ä¸­ï¼Œå¯ä»¥ç”¨æ …æ å—æ¥å®ç°å±æ€§çš„è®¾ç½®æ–¹æ³•ã€‚åœ¨è®¾ç½®æ–¹æ³•ä¸­ä½¿ç”¨äº†æ …æ å—ä¹‹åï¼Œå¯¹å±æ€§çš„è¯»å–æ“ä½œä¾ç„¶å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œä½†å†™å…¥æ“ä½œå´å¿…é¡»å•ç‹¬æ‰§è¡Œäº†ã€‚åœ¨ä¸‹å›¾ä¸­æ¼”ç¤ºçš„è¿™ä¸ªé˜Ÿåˆ—ä¸­ï¼Œæœ‰å¤šä¸ªè¯»å–æ“ä½œï¼Œè€Œä¸”è¿˜æœ‰ä¸€ä¸ªå†™å…¥æ“ä½œã€‚



![queue Image](SecretOfGCDLocks/Queue.png)

åœ¨è¿™ä¸ªå¹¶å‘é˜Ÿåˆ—ä¸­ï¼Œè¯»å–æ“ä½œæ˜¯ç”¨æ™®é€šçš„å—æ¥å®ç°çš„ï¼Œè€Œå†™å…¥æ“ä½œåˆ™æ˜¯ç”¨æ …æ å—æ¥å®ç°çš„ è¯»å–æ“ä½œå¯ä»¥å¹¶è¡Œï¼Œä½†å†™å…¥æ“ä½œå¿…é¡»å•ç‹¬æ‰§è¡Œï¼Œå› ä¸ºå®ƒæ˜¯æ …æ å—

å®ç°ä»£ç å¾ˆç®€å•ï¼š

```objc
@property (nonatomic,strong) dispatch_queue_t syncQueue;

//_syncQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
/* è¿™é‡Œåº”è¯¥ä½¿ç”¨è‡ªå·±åˆ›å»ºçš„å¹¶å‘é˜Ÿåˆ—ï¼Œå› ä¸ºè‹¹æœæ–‡æ¡£ä¸­æŒ‡å‡ºï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯å…¨å±€é˜Ÿåˆ—æˆ–è€…åˆ›å»ºçš„ä¸æ˜¯å¹¶å‘é˜Ÿåˆ—ï¼Œ
åˆ™dispatch_barrier_asyncå®é™…ä¸Šå°±ç›¸å½“äºdispatch_asyncï¼Œå°±è¾¾ä¸åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœäº† */
_syncQueue = dispatch_queue_create("com.effetiveobjectivec.syncQueue", DISPATCH_QUEUE_CONCURRENT);

- (NSString *)someString {
    __block NSString *localSomeString;
    dispatch_sync(_syncQueue, ^{
        localSomeString = _someString;
    });
    return localSomeString;
}

- (void)setSomeString:(NSString *)someString {
    dispatch_barrier_async(_syncQueue, ^{
        _someString = someString;
    });
}

// æ›´ä¼˜è§£
/** - (void)setSomeString:(NSString *)someString {
    dispatch_barrier_sync(_syncQueue, ^{
        _someString = someString;
    });
}*/
```

æµ‹è¯•ä¸€ä¸‹æ€§èƒ½ï¼Œä½ å°±ä¼šå‘ç°ï¼Œè¿™ç§åšæ³•è‚¯å®šæ¯”ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—è¦å¿«ã€‚å…¶ä¸­ï¼Œè®¾ç½®å‡½æ•°ä¹Ÿå¯ä»¥æ”¹ç”¨åŒæ­¥æ …æ å—æ¥å®ç°ï¼Œé‚£æ ·åšå¯èƒ½ä¼šæ›´é«˜æ•ˆï¼Œå…¶åŸå› ä¹‹å‰å·²ç»è§£é‡Šè¿‡äº†â€”â€”*è¿™é‡Œå°±è¦æƒè¡¡æ‹·è´å—çš„æ—¶é—´å’Œå—æ‰§è¡Œæ—¶é—´äº†*

> ä½œè€…ï¼šHK_Hank é“¾æ¥ï¼šhttps://www.jianshu.com/p/306481753216
